<!DOCTYPE HTML>
<html lang="ko">
    <head>
        <meta charset="utf-8">
        <title>1394-Para Probe Card for SP2003 Emulator</title>
        <link rel="stylesheet" href="styles/style.css">
        <link rel="stylesheet" href="styles/button.css">
        <!--
        <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.15.5/xlsx.full.min.js"></script>
        -->
        <script type="text/javascript" src="./Bank Map.json"></script>
        <script type="text/javascript" src="./Wafer Map.json"></script>
        <script type="text/javascript" src="constants/constants.js"></script>
        <script type="text/javascript" src="constants/jquery-3.4.1.min.js"></script>
        <script type="text/javascript" src="constants/xlsx.full.min.js"></script>
        <style>
/*
            input[type="file"] {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                border: 0;
            }
            */
            .inputfile {
                width: 0.1px;
                height: 0.1px;
                opacity: 0;
                overflow: hidden;
                position: absolute;
                z-index: -1;
            }
            .inputfile + label {
                font-size: 1.25em;
                font-weight: 700;
                /*
                color: white;
                    */
                color: #555;                /* label text color */
                background-color: black;
                display: inline-block;
                cursor: pointer;    /* "hand" cursor */

                -moz-box-shadow: inset 0 0 0 1px #63ad0d;
                -webkit-box-shadow: inset 0 0 0 1px #63ad0d;
                -moz-border-radius: 3px;
                -webkit-border-radius: 3px;
                box-shadow: inset 0 0 0 1px #f5f5f5;
                border-radius: 5px;
                background: #eee;
                background: -webkit-gradient(linear, 0 0, 0 bottom, from(#eee), to(#e2e2e2));
                background: -moz-linear-gradient(#eee, #e2e2e2);
                background: linear-gradient(#eee, #e2e2e2);
                border: solid 1px #d0d0d0;
                border-bottom: solid 3px #b2b1b1;
                display: inline-block;
                font: bold 12px Arial, Helvetica, Clean, sans-serif;
                margin: 0 5px 0px 0;
                padding: 8px 20px 9px;
                position: relative;
                text-align: center;
                text-decoration: none;
                text-shadow: 0 1px 0 #fafafa;
            }
            .inputfile:focus + label,
            .inputfile + label:hover {
                /*
                background-color: red;
                outline: 1px dotted #000;
                outline: -webkit-focus-ring-color auto 5px;
                */
                background: #e4e4e4;
                background: -webkit-gradient(linear, 0 0, 0 bottom, from(#e4e4e4), to(#ededed));
                background: -moz-linear-gradient(#e4e4e4, #ededed);
                background: linear-gradient(#e4e4e4, #ededed);
                border: solid 1px #c2c2c2;
                border-bottom: solid 3px #b2b1b1;
                box-shadow: inset 0 0 0 1px #efefef;
            }
            .inputfile + label:active {
                background: #ff0000;/*#dfdfdf;*/
                background: -webkit-gradient(linear, 0 0, 0 bottom, from(#dfdfdf), to(#e3e3e3));
                background: -moz-linear-gradient(#dfdfdf, #e3e3e3);
                background: linear-gradient(#dfdfdf, #e3e3e3);
                border: solid 1px #959595;
                box-shadow: inset 0 10px 15px 0 #c4c4c4;
                top:2px;
            }
            /*
            .inputfile:focus + label {
                outline: 1px dotted #000;
                outline: -webkit-focus-ring-color auto 5px;
            }
            */
            .drop-file {
                display: inline-block;
            }
        </style>
    </head>

    <body>
        <center>
        <!--
        <div id="loadfile" name="contents"></div>
        -->
        <!--
        <label for="WaferMap">
        <input type="file" id='WaferMap' class="button gray" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" onchange="WaferMapRead()">Wafer Map File</label>
        // click OK
        -->
        <div id='drop-area1' class='drop-file' multiple>
        <input type="file" id='WaferMap' class="inputfile" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" onchange="WaferMapRead()">
        <label for="WaferMap">Wafer Map File</label>
        </div>
        <!--
        <input type="file" id="WaferMap" class='inputfile' 'onchange'='WaferMapRead()'>
        <label for="WaferMap">Wafer Map File</label>
        -->

        <!--
        // click OK
        -->
        <div id='drop-area2' class='drop-file'>
        <input type="file" id='BankMap' class="inputfile" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" onchange="BankMapRead()">
        <label for="BankMap">Bank Map File</label>
        </div>
        <!--
        <input type="file" id="BankMap" class='inputfile' onchange="BankMapRead()">
        <label for="BankMap">Bank Map File</label>
        -->

        &emsp; &emsp;
        <button class="button pink" onclick="createwafer()">Create Card</button>

        <div id="selectDutNumber" class="labeltext text">
        &emsp;SP2003 AV<sub>in</sub> 
        <input type="number" id="AVin" min="0" max="5" class='digit3' step='0.1' placeholder='Vin' value='2.8'>
        &emsp;Dut No. 
        <input type='number' id='DutNumber' min='1.1' max='236.8' class='digit4' step='0.1' value='1.1' onchange='setFloatNumber(event)'>
        &emsp;
        <button id="DutSelect" class="button blue">Open Bank Map</button>
        &emsp;
        <button class="button orange" onclick="OpenCommandList()">Open Command List</button>
        </div>
        </center>

        <div id='tooltip' style='position:absolute; display:none;'></div>
        <div id='svgContainer' name='container' align="center"></div>


        <script type="text/javascript">
            var BankMap = new Object();
            var WaferMap = new Object();
            var SelectedDut = new Object;
            var BankWindow;
            var ChipWindow;
            var CmdListWindow;

            // Global variable list.
            var maxGROUP = 0;
            var DefaultLevel = 1200;
            var CurrentLevel;
            var MaxLevel;

            function setFloatNumber(e) {
                var newValue = e.target.value;
                var oldValue = $('#DutNumber').data('old');

//            console.log(`${oldValue} -> ${newValue}`);

                if( newValue > 236.8 ) newValue = 236.8;

                if( newValue > oldValue ) {       // up.
                    if( (newValue > 44.8) && (newValue < 65.1) ) {
                        newValue = 65.1;
                    } else if( (newValue > 108.8) && (newValue < 129.1) ) {
                        newValue = 129.1;
                    } else if( (newValue > 172.8) && (newValue < 193.1) ) {
                        newValue = 193.1;
//                    } else if( newValue > 236.8 ) {
//                        newValue = 236.8;
                    }
                } else {                            // down.
                    if( (newValue > 44.8) && (newValue < 65.1) ) {
                        newValue = 44.8;
                    } else if( (newValue > 108.8) && (newValue < 129.1) ) {
                        newValue = 108.8;
                    } else if( (newValue > 172.8) && (newValue < 193.1) ) {
                        newValue = 172.8;
//                    } else if( newValue > 236.8 ) {
//                        newValue = 236.8;
                    }
                }

                var n = (parseFloat(newValue) * 10) % 10;
                if( n == 9 ) {
                    newValue = parseInt(newValue) + 1.1;
                } else if( n == 0 ) {
                    newValue = parseInt(newValue) - 0.2;
                }
                e.target.value = parseFloat(newValue).toFixed(1);
                $('#DutNumber').data('old', e.target.value);
            }

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            const dropArea1 = document.getElementById('drop-area1');
            const dropArea2 = document.getElementById('drop-area2');

            dropArea1.addEventListener('dragenter', highlight, false);
            dropArea1.addEventListener('dragover', highlight, false);
            dropArea1.addEventListener('draleave', unhighlight, false);
            dropArea1.addEventListener('drop', handleDrop1, false);

            dropArea2.addEventListener('dragenter', highlight, false);
            dropArea2.addEventListener('dragover', highlight, false);
            dropArea2.addEventListener('draleave', unhighlight, false);
            dropArea2.addEventListener('drop', handleDrop2, false);

            function highlight(e) {
//                console.log('highlight');
//                console.log(e);
                preventDefaults(e);
//                dropArea1.classList.add('highlight');
            }

            function unhighlight(e) {
//                console.log('unhighlight');
                preventDefaults(e);
//                dropArea1.classList.add('highlight');
            }

            function WaferMapToJSON(file) {
                let reader = new FileReader();

                $("label[for='WaferMap']").text(file.name);
                reader.onload = function () {
                    let data = reader.result;
                    let workBook = XLSX.read(data, { type: 'binary' });
                    let IntArr = [];

                    var cols;
                    workBook.SheetNames.forEach(function (sheetName, sheetNumber) {
                        if( sheetNumber != 0 ) return;              // 첫번째 Sheet만 처리한다.
//                        console.log('SheetName: ' + sheetName);
                        let str = XLSX.utils.sheet_to_csv(workBook.Sheets[sheetName]);
//                        let str = XLSX.utils.sheet_to_json(workBook.Sheets[sheetName]);
//                        let str = XLSX.utils.sheet_to_html(workBook.Sheets[sheetName]);
//                        console.log(JSON.stringify(str));

                        var strArray = str.split('\n');    // line단위로 문자열을 읽어서 Array에 저장한다.
                        strArray.pop();                // 마지막 요소를 제거함.
                        if( strArray.length == 0 ) return;

//                        console.log(`length = ${strArray.length}`);
                        // Column Cell 전체가 비어있으면(숫자가 아니면), 제거해야 한다.
                        strArray.forEach(function(line, idx) {      // 각 Line의 문자열을 처리한다.
//                            console.log('line : ', line);

                            // 비어있는 라인을 check한다.
                            var result = line.split(',').some( element => {
                                if( element !== '' ) return true;
                            });
                            if( result == false ) return;

                            var arr = line.split(',').map(function(item, col) {  // Line 문자열에서 각 Cell의 값을 Array에 저장한다.
                                return parseInt(item);
                            });
//                            console.log(`length = ${arr.length}`);
                            IntArr.push(arr);                       // Line단위의 Cell 값을 갖는 Array를 Array에 저장한다.
                        });

                        // Row, Column단위로 모두 NaN이면 Array에서 제거한다.

                        console.log(`length = ${IntArr.length}`);
                        WaferMap.maxRow = IntArr.length;      // Line의 개수.
                        WaferMap.maxCol = IntArr[0].length;
                        WaferMap.filename = "Wafer Map";
                        WaferMap.Duts = IntArr;

                        console.log('Wafer Map : ', WaferMap);
                    })

                    saveFile('WaferMap', WaferMap);

                };

                reader.readAsBinaryString(file);
            }

            function SP2003_Init() {
                var sp2003 = new Object();

                sp2003.id = 0;
                sp2003.Assign = 0;
                sp2003.Group = 0;
                sp2003.OnOff = 0;             // SW0(bit[5]), LDO0(bit[4]), LDO1(bit[3]), SW1(bit[2]), LDO2(bit[1]), LDO3(bit[0])
                sp2003.Reject = 0;
                sp2003.LDO02Level = DefaultLevel;
                sp2003.LDO13Level = DefaultLevel;
                sp2003.COMMON = 0;            // CLS(bit[5]), AD(bit[4]), RCB(bit[3]), FB(bit[2]), TSD(bit[1])
                sp2003.TEST = 0;              // Body(bit[3]), tFLAG(bit[2])
                sp2003.TempOffset = 0;
                sp2003.CLS_FLAGS = 0;
                sp2003.TSD150_FLAGS = 0;
                sp2003.TSD170_FLAGS = 0;
                sp2003.AnalogOut = 0;
                sp2003.MuxSelect = 0;
                sp2003.LDO_REF = 0;
                sp2003.TSD_TEST = 0;
                sp2003.OSC_OUT = 0;

                // Map에서 sp2003의 위치 : site, bank, page, pps, group, dut, ...
                sp2003.ExpandCommand = 0;

//                    console.log(sp2003);

                // TRIM Register
                var reg = new Array(20).fill(0);
                sp2003.OTP = reg;

                return sp2003;
            }

            function BankMapToJSON(file) {
                let reader = new FileReader();
                let CellEntry = [];

                $("label[for='BankMap']").text(file.name);
                reader.onload = function () {
                    let data = reader.result;
                    let workBook = XLSX.read(data, { type: 'binary' });
                    let tBankMap = new Object();
//                    console.log('file name : ', file.name, file.name.split('.'));
                    tBankMap.filename = file.name.split('.')[0];
                    tBankMap.device = 2;                        // unused
                    tBankMap.AVin = 0;
                    tBankMap.DutPower = 0;
                    tBankMap.maxGROUP = 0;
                    tBankMap.maxDUTs = 0;
                    tBankMap.ChipsPerBank = 0;
                    tBankMap.DutsPerChip = 0;
                    tBankMap.BankCnt = 0;

                    tBankMap.BankCnt = 0;
                    tBankMap.Banks = [];
                    workBook.SheetNames.forEach(function (sheetName, sheetNumber) {
                        if( sheetNumber != 0 ) return;              // 첫번째 Sheet만 처리한다.
//                        console.log('SheetName: ' + sheetName);
                        let str = XLSX.utils.sheet_to_csv(workBook.Sheets[sheetName]);
//                        let str = XLSX.utils.sheet_to_json(workBook.Sheets[sheetName]);
//                        let str = XLSX.utils.sheet_to_html(workBook.Sheets[sheetName]);
//                        console.log(JSON.stringify(str));

                        var StrLine = str.split('\n');
                        StrLine.pop();                // 마지막 요소를 제거함.
                        if( StrLine.length == 0 ) return;

//                        console.log(`line length = ${StrLine.length}`);
                        var BankCnt = 0;
                        var ChipsPerBank = 0;
                        var PageCnt = 0;
                        var totalDuts = 0;
                        var Bank;
                        var Page;
                        var DutsPerChip;
                        var group = 0;
                        var PPSNum = 0;
                        StrLine.forEach(function(Line, idx) {                   // xlsx line read.

                            // 'AVin' parsing.
                            if( tBankMap.AVin == 0 ) {
                                if( Line.includes('AVin') ) {           // find "BANK" string.
                                    Line.split(',').some(function(item, i, items) {
                                        if( item.includes('AVin') ) {
                                            tBankMap.AVin = parseFloat(items[i+1]) * 1000;
                                            return true;
                                        }
                                        return false;
                                    });
                                }
                            }

                            // 'DUT Power' parsing.
                            if( tBankMap.DutPower == 0  ) {
                                if( Line.includes('Power') ) {
                                    Line.split(',').some(function(item, i, items) {
                                        if( item == 'Power' ) {
                                            tBankMap.DutPower = parseInt(items[i+1]);
                                            return true;
                                        }
                                        return false;
                                    });
                                }
                            }

                            if( Line.includes('BANK') ) {           // find "BANK" string.
//                                console.log('find Bank');
                                BankCnt++;
                                if( PageCnt != 0 ) {
                                    tBankMap.Banks.push(Bank);    // Bank Object를 tBankMap에 추가한다.
                                }
                                Bank = new Object();
                                PageCnt = 0;
                                Bank.PageCnt = 0;
                                Bank.Pages = [];
                            }

                            if( Line.includes('CHIP') ) {      // find "CHIP" string.
//                                console.log('find Chip');
                                Page = new Object();
                                var ChipCnt = 0;
                                var Chips = [];
                                Line.split(',').map(function(item, i) {
                                    if( item.includes('CHIP') ) {
                                        var chip = new Object();
                                        chip.number = parseInt(item.slice(6));
                                        chip.SP2003 = SP2003_Init();
                                        chip.Duts = [];
                                        Chips.push(chip);
                                        ChipCnt++;
                                    }
                                    return;
                                });
                                Page.ChipCnt = ChipCnt;
                                Page.Chips = Chips;
                                if( group < ChipCnt ) group = ChipCnt;      // chip의 최대 개수가 Group이 된다.

                                PageCnt++;
//                                Bank.PageCnt++;
//                                Bank.Pages.push(Page);
//                                console.log(`${idx} line : ChipCnt = ${ChipCnt}`);
                            }

//                console.log('page object : ', Page);
                            // 1개의 Page에 대한 Dut Number를 Read한다.
                            if( Line.includes('DUT') ) {        // find "DUT" string, 1-page read.
//                                console.log('find Dut');
                                var DutCnt = 0;
                                var Duts = [];

                                console.log('line : ', Line);
                                Line.split(',').map(function(item, i) {     // 1 line에서 각 cell을 parsing한다.
                                    if( item === '' ) return;

                                    // dut는 [Group Number, Group Index]로 구성된다, dut[0]는 Group Number이고, dut[1]은 Group Index이다.
                                    var dut = item.split(/[\s,._]+/).map(function(num, n) {
                                        return parseInt(num);
                                    });
                                    if( !isNaN(dut[0]) && !isNaN(dut[1]) ) { 
//                console.log('Page : ', Page);
                var n;
                console.log('dut = ', dut);
                                        if( dut[0] < 65 ) {
                                            n = ((dut[0] - (0 + 1)) * 8) + dut[1];
                                        } else if( dut[0] < 129 ) {
                                            n = ((dut[0] - (20 + 1)) * 8) + dut[1];
                                        } else if( dut[0] < 193 ) {
                                            n = ((dut[0] - (40 + 1)) * 8) + dut[1];
                                        } else {
                                            n = ((dut[0] - (60 + 1)) * 8) + dut[1];
                                        }
                                        Page.Chips[DutCnt >> 1].Duts.push( n );

                                        /*
                                        if( Page.ChipCnt == 8 ) {           // 8분기
//                                            if( dut[0] < 41 ) {
                                                Page.Chips[DutCnt >> 1].Duts.push( ((dut[0] - 1) * 32) + dut[1]);
//                                            } else {
//                                                Page.Chips[DutCnt >> 1].Duts.push( ((dut[0] - 41) * 32) + dut[1] + 1280);
//                                            }
                                        } else if( ChipCnt == 10 ) {        // 10분기
                                            if( dut[0] < 44 ) {
                                                Page.Chips[DutCnt >> 1].Duts.push( ((dut[0] - 1) * 30) + dut[1]);   // ((GroupNumber - 1) * 
                                            } else {
                                                Page.Chips[DutCnt >> 1].Duts.push( ((dut[0] - 44) * 30) + dut[1] + 1280);
                                            }
                                        }
                                        */
                                        DutCnt++;
                                    }
                                });
//                console.log('page object : ', Page);
//                                console.log(`Page = ${PageCnt}, DutCnt = ${DutCnt}, ChipCnt = ${Page.ChipCnt}`);
                                DutsPerChip = Math.ceil(DutCnt / Page.ChipCnt);

//                                console.log(`Page = ${PageCnt}, DutCnt = ${DutCnt}, Duts = ${Duts}`);
                                Page.DutCnt = DutCnt;
                                Page.nPPS = [PPSNum++, PPSNum++];
//                                Page.Duts = Duts;
                                totalDuts += DutCnt;

                                Bank.PageCnt = PageCnt;
                                Bank.Pages.push(Page);
                            }
                        });


                        tBankMap.Banks.push(Bank);

//                        tBankMap.device = 2;
//                        tBankMap.AVin = '2.8';
                        tBankMap.maxGROUP = group;
                        tBankMap.maxDUTs = totalDuts;
                        tBankMap.DutsPerChip = DutsPerChip;
                        tBankMap.ChipsPerBank = parseInt((tBankMap.Banks[0].PageCnt * tBankMap.Banks[0].Pages[0].DutCnt) / DutsPerChip);
                        tBankMap.BankCnt = BankCnt;

                        console.log('new BankMap : ', tBankMap);
//                        console.log(JSON.stringify(tBankMap));
//                        console.log(`device = ${tBankMap.device}`);
//                        console.log(`maxDUTs = ${tBankMap.maxDUTs}`);
                        console.log(`maxGROUP = ${tBankMap.maxGROUP}`);
//                        console.log(`DutsPerChip = ${tBankMap.DutsPerChip}`);
//                        console.log(`ChipsPerBank = ${tBankMap.ChipsPerBank}`);
//                        console.log(`BankCnt = ${tBankMap.BankCnt}`);
                    })

                    BankMap = tBankMap;
                    saveFile('BankMap', BankMap);
//                    console.log(`BankMap = ${BankMap.filename}`);
                };

                reader.readAsBinaryString(file);
            }

            function handleDrop1(e) {
                preventDefaults(e);
//                let files = e.dataTransfer.files;
//                console.log(files);

                WaferMapToJSON(e.dataTransfer.files[0]);
            }
            function handleDrop2(e) {
                preventDefaults(e);
                BankMapToJSON(e.dataTransfer.files[0]);
            }





            window.onmessage = function(e) {
//                console.log("onmessage");
//                console.log('Selected Dut : ', SelectedDut);
//                console.log(e);
//                console.log(e.data.ATECmd);
                if( e.data.ATECmd === undefined ) return;

                var cmd = e.data.ATECmd.split(/[\s,._]+/).map(function(num, n) {
                    return parseInt(num);
                });
                RunCommand(cmd);
            }

//            $(document).ready(function(){
            $(function(){
                if( typeof JSONBankMap !== 'undefined' ) {
//                    console.log(`used "Bank Map.json" file`);
                    BankMap = JSONBankMap;
                } else {
//                    console.log(`used "DefaultBankMap" variable`);
                    BankMap = DefaultBankMap;
                }
                console.log('Loading Bank Map : ', BankMap);

                if( typeof JSONWaferMap !== 'undefined' ) {     // JSON(String) to Number
//                    console.log(`used "Wafer Map.json" file`);
                    WaferMap.filename = JSONWaferMap.filename;
                    WaferMap.maxCol = JSONWaferMap.maxCol;
                    WaferMap.maxRow = JSONWaferMap.maxRow;
                    WaferMap.Duts = [];
                    // string to number.
                    JSONWaferMap.Duts.forEach(function(sLine, idx) {
                        var nLine = sLine.map(function(item) {
                            return parseInt(item);
                        });
                        WaferMap.Duts.push(nLine);
                    });
                } else {                    // Number.
//                    console.log(`used "DefaultWaferMap" variable`);
                    WaferMap = DefaultWaferMap;
                }
                console.log('Loading Wafer Map : ', WaferMap);

                createwafer();

                // for Test.
//                        $('.oDUT').attr('fill', 'red');
//                        $('.eDUT').attr('fill', 'blue');

                SelectedDut.iBank = 0;
                SelectedDut.iPage = 0;
                SelectedDut.nDut = 1;

                // web server를 사용하지 않고, index.html 파일을 바로 open한 경우.
                if( window.location.protocol === 'file:' ) {
                    // create Local Storage.
                    localStorage.setItem("BankMap", JSON.stringify(BankMap));

//                    let map = localStorage.getItem("BankMap");
//                    console.log(map);
//                    console.log(JSON.stringify(map));
//                    console.log(`${JSON.stringify(JSON.parse(map))}`);

//                    console.log(window.location.protocol);
                }

                // 브라우저의 Window 크기에 맞추어서 svg영역을 재설정한다.
                var w = $(window).width();
                var h = $(window).height();
//                console.log(`window size : (${w} x ${h})`);

                $('#ProbeCard').width(w-30);
                $('#ProbeCard').height(h-100);
//                console.log(`inner size : ${$('#ProbeCard').innerWidth()} x ${$('#ProbeCard').innerHeight()}`);
//                console.log(`rect width = ${$('#Card').width()}`);
                console.log('SelectedDut : ', SelectedDut);
            });

            // 브라우저 windows의 크기를 변경하면 Call된다.
            $(window).resize( function() {
                var w = $(window).width();
                var h = $(window).height();

                $("#ProbeCard").width(w-30);
                $("#ProbeCard").height(h-100);

//            console.log(`inner size : ${$('#ProbeCard').innerWidth()} x ${$('#ProbeCard').innerHeight()}`);
        });

            $(document).on('change', '#AVin', function(e) {
                console.log(`type = ${e.type}, target value = ${e.target.value}, ${$(this).data('val')}`);
                BankMap.AVin = parseFloat(e.target.value) * 1000;
                console.log(`AVin = ${BankMap.AVin}`);
            });

            $(document).on('click', '#DutSelect', function(e) {
//                var dut = parseInt($('#DutNumber').val());
                var dut = parseFloat($('#DutNumber').val());
                var n = IndicaterToNumber(dut);
                console.log(`dut = ${n}`);
                dutClick(n);
            });

            function WaferMapRead() {
                WaferMapToJSON(event.target.files[0]);
            }

            $('.dut').on('click', function(e) {
                console.log(`type = ${e.type}, target value = ${e.target.value}, ${$(this).data('val')}`);
            });

            function showTooltip(event) {
//                let tooltip = $('#tooltip');
                let tooltip = document.getElementById('tooltip');
                tooltip.innerHTML = NumberToIndicater(event.target.getAttribute('value'));
                tooltip.style.display = 'block';
//                tooltip.style.left = (event.pageX - 40) + 'px';
//                tooltip.style.top = (event.pageY - 20) + 'px';
                tooltip.style.left = event.pageX + 'px';
                tooltip.style.top = event.pageY + 'px';
//                console.log(`value = ${event.target.getAttribute('value')} mouse enter event x = ${event.pageX}, y = ${event.pageY}\n`);
            }

            function hideTooltip(event) {
                let tooltip = document.getElementById('tooltip');
                tooltip.style.display = 'none';
//                console.log(`mouse out event x = ${event.pageX}, y = ${event.pageY}\n`);
            }


            function OpenBankView() {
                $(`.dut`).attr('stroke', 'black').attr('stroke-width', 1);
//                $(`.dut${SelectedDut.nDut}`).attr('stroke', 'red').attr('stroke-width', 2);

                // 같은 Page에 있는 Dut들을 표시한다.
                BankMap.Banks[SelectedDut.iBank].Pages[SelectedDut.iPage].Chips.forEach(function(Chip, ChipIdx) {
                    $(`.dut${Chip.Duts[0]}`).attr('stroke', 'blue').attr('stroke-width', 2);
                    $(`.dut${Chip.Duts[1]}`).attr('stroke', 'red').attr('stroke-width', 2);
                });
//                BankMap.Banks[SelectedDut.iBank].Pages.forEach(function(Page, PageIdx) {
//                    Page.Chips.forEach(function(Chip, ChipIdx) {
//                        $(`.dut${Chip.Duts[0]}`).attr('stroke', 'blue').attr('stroke-width', 2);
//                        $(`.dut${Chip.Duts[1]}`).attr('stroke', 'blue').attr('stroke-width', 2);
//                    });
//                });



                if( window.location.protocol === 'file:' ) {
                    localStorage.setItem("SelectedDut", JSON.stringify(SelectedDut));
                    localStorage.setItem("BankMap", JSON.stringify(BankMap));
                }
//                console.log('SelectedDut : ', SelectedDut);
//                console.log(`Window position : (${window.screenX}, ${window.screenY}), width(${window.innerWidth}), height(${window.innerHeight})`);

                var url = 'BankMap.html';

                /*
                // @ web client
                url += `?maxDUTs=${maxDUTs}`;
                url += `&BANK=${$(bank).attr('value')}`;
                url += `&maxGROUP=${maxGROUP}`;
                url += `&ChipsPerBank=${ChipsPerBank}`;
                url += `&DutsPerChip=${DutsPerChip}`;
                */

                var bus = Math.ceil(BankMap.ChipsPerBank / BankMap.maxGROUP);
                var width = (BankMap.maxGROUP * 60) + 200;
                var height = (bus * 100)+60;

                // 화면의 (10,10) 위치에 BankMap.html을 출력한다.
                var left = 10;
                var top = 10;

                // 1920 x 1200 display.
                if( window.screenX > window.screen.width ) left += window.screen.width;
                if( window.screenY > window.screen.height ) top += window.screen.height;


                console.log(`open windonw : (${left}, ${top}), ${width} x ${height}`);

                var opt = `toolbar=no, menubar=no, location=no, status=no, target=_blank`;
                opt += `, width=${width}, height=${height}, top=${top}, left=${left}`;

                BankWindow = window.open(url, 'Bank Map', opt);
            }

            /*
            function OpenChipView(chip) {
                $('.CHIP').attr('stroke', 'black');
                $(`#CHIP${chip}`).attr('stroke', 'red');

                var url = 'CHIP.html';

                url += `?CHIP=${chip}`;
                url += `&BANK=${nBank}`;
                url += `&AVIN=${AVin}`;
                if( SP2003List[index].Assign == 1 ) {
                    url += `&GROUP=${SP2003List[index].Group}`;
                }
                url += `&ONOFF=${SP2003List[index].OnOff}`;
                url += `&REJECT=${SP2003List[index].Reject}`;
                url += `&COMMON=${SP2003List[index].COMMON}`;
//                url += `&CLS=${SP2003List[index].CLS_FLAGS}`;
//                url += `&TSD150=${SP2003List[index].TSD150_FLAGS}`;
//                url += `&TSD170=${SP2003List[index].TSD170_FLAGS}`;
                url += `&LEVEL0=${SP2003List[index].LDO02Level}`;
                url += `&LEVEL1=${SP2003List[index].LDO13Level}`;

                console.log(`url : ${url}`);
                var width = 500;
                var height = 410;//430;

                // BankMap 화면 아래에 바로 붙여서 출력하도록 한다.
                var left = window.screenX;
                var top = window.screenY + window.innerHeight + 61;

                var opt = `toolbar=no, menubar=no, location=no, status=no, target=_blank`;
                opt += `, width=${width}, height=${height}, top=${top}, left=${left}`;
                ChipWindow = window.open(url, 'SP2003', opt);
            }
            */

            function dutClick(dutNumber) {
                $('#DutNumber').val(NumberToIndicater(dutNumber));             // dut 선택창의 값을 변경한다.

                var nDut = parseInt(dutNumber);
                console.log(`dut number = ${nDut}`);

//                console.log(`BankMap = ${JSON.stringify(BankMap)}`);
                // dut number to chip number
                BankMap.Banks.some( function(Bank, BankIdx) {
                    return Bank.Pages.some( function(Page, PageIdx) {
                        return Page.Chips.some( function(Chip, ChipIdx) {
                            if( Chip.Duts.includes(nDut) ) {                // Duts[]배열에 dut number가 있는지 check한다.
                                var idx = Chip.Duts.indexOf(nDut);       // dut number의 index를 가져온다.( 0 or 1 )

                                idx = idx >> 1;
                                SelectedDut.iBank = BankIdx;
                                SelectedDut.iPage = PageIdx;
                                SelectedDut.nChip = Chip.number;
                                SelectedDut.nDut = nDut;
//                            console.log(`iBank = ${BankIdx}, iPage = ${PageIdx}, nChip = ${nChip}`);
                                return true;
                            }
                            return false;
                        });
                    });
                });
//                var nChip = (nDut > 1280) ? nDut - 1280 : nDut;         // dut number to chip number.

                /*
                // 선택된 DUT가 포함된 Bank의 모든 Dut를 표시한다.
                $(`.oDUT`).attr('fill', 'transparent').attr('stroke', 'black').attr('stroke-width', 2).attr('opacity', 1);
                $(`.eDUT`).attr('fill', 'transparent').attr('stroke', 'black').attr('stroke-width', 2).attr('opacity', 1);

                $(`.Bank${SelectedDut.iBank}.oDUT`).attr('fill','red').attr('opacity',0.7);                 // class : .Bank${iBank} and .oDUT
                $(`.Bank${SelectedDut.iBank}.eDUT`).attr('fill','blue').attr('opacity',0.7);                // class : .Bank${iBank} and .eDUT

//                console.log(`chip number = ${SelectedDut.nChip}`);
                */

                $(`.dut`).attr('fill', 'transparent');
                $(`.dut${SelectedDut.nDut}`).attr('fill', 'red');
                OpenBankView();
//                OpenChipView(nChip);
            }

            function BankMapRead() {
                BankMapToJSON(event.target.files[0]);
            }

            let saveFile = (type, Data) => {
//                console.log(`Bank Map = ${JSON.stringify(Data)}`);

                // Convert the text to BLOB.
                var name;
                if( type == 'BankMap' ) {
                    name = 'JSONBankMap';
                } else {
                    name = 'JSONWaferMap';
                }
                const textToBLOB = new Blob([`var ${name} = \n` + JSON.stringify(Data)], { type: "application/json" });

                const filename = Data.filename;        // default file name.
//                console.log(`filename = ${filename}`);

                let newLink = document.createElement("a");
//            newLink.download = new Date();
                newLink.download = filename;

                if (window.webkitURL != null) {
                    newLink.href = window.webkitURL.createObjectURL(textToBLOB);
                } else {
                    newLink.href = window.URL.createObjectURL(textToBLOB);
                    newLink.style.display = "none";
                    document.body.appendChild(newLink);
                }

                newLink.click();
            };

            function NumberToIndicater( num ) {
                /*
                if( num < 353 ) {
                    return ((Math.ceil(num / 8) + 0) + ((((num-1) % 8) + 1) / 10));
                } else if( num < 705 ) {
                    return ((Math.ceil(num / 8) + 20) + ((((num-1) % 8) + 1) / 10));
                } else if( num < 1057 ) {
                    return ((Math.ceil(num / 8) + 40) + ((((num-1) % 8) + 1) / 10));
                } else {
                    return ((Math.ceil(num / 8) + 60) + ((((num-1) % 8) + 1) / 10));
                }
                */
                return ((Math.ceil(num / 8) + (parseInt((num-1) / 352)*20)) + ((((num-1) % 8) + 1) / 10));
            }

            function IndicaterToNumber( ind ) {
                var a = parseInt(ind * 10);
                var b = parseInt(a / 10);
                return (((b - 1) - (20 * parseInt(b / 64))) * 8) + (a % 10);
                // 1.1 -> 1               1.8 -> 8
                // 2.1 -> 9               2.8 -> 16
                // ...
                // 44.1 -> 345            44.8 -> 352
                // 65.1 -> 353            65.8 -> 360
                // ...
                // 108.1 -> 697           108.8 -> 704
                // 129.1 -> 705           129.8 -> 712
                // ...
                // 172.1 -> 1049           172.8 -> 1056
                // 193.1 -> 1057           193.8 -> 1064
                // ...
                // 236.1 -> 1401           236.8 -> 1408

                /*
                if( dut[0] < 65 ) {
                    n = (((dut[0] - 1) - (20 * 0)) * 8) + dut[1];
                } else if( dut[0] < 129 ) {
                    n = (((dut[0] - 1) - (20 * 1)) * 8) + dut[1];
//                    n = ((dut[0] - (20 + 1)) * 8) + dut[1];
                } else if( dut[0] < 193 ) {
                    n = (((dut[0] - 1) - (20 * 2)) * 8) + dut[1];
//                    n = ((dut[0] - (40 + 1)) * 8) + dut[1];
                } else {
                    n = (((dut[0] - 1) - (20 * 3)) * 8) + dut[1];
//                    n = ((dut[0] - (60 + 1)) * 8) + dut[1];
                }
                */
                }

            function createwafer() {
                /*
                for(var i=1; i<1409; i++) {
                    var ind = NumberToIndicater(i);
                    n = IndicaterToNumber(ind);
                    console.log(`i = ${i}, ind = ${ind}, n = ${n}`);
                }
                */
                document.getElementById('svgContainer').innerHTML = ""; // 기존에 생성된 Wafer Map을 제거한다.
                // drawing svg
                var svg = document.createElementNS(xmlns, 'svg');
//                console.log(svg);

                var sx = 10;
                var sy = 10;

                var x, y, w, h, dw, dh;

                x = sx;
                y = sx;
                w = 16;
                h = 16;
                dw = 4;
                dh = 4;

                var maxRow = parseInt(WaferMap.maxRow);
                var maxCol = parseInt(WaferMap.maxCol);

                WaferMap.Duts.forEach(function(row, n) {
                    row.forEach(function(col, m) {
                        x = sx + ((w + dw) * m);
//                        console.log(`col type = ${typeof col}, ${col}, ${m}`);
//                        if( isNaN(col) ) return;
                        if( !isNaN(col) ) {
//                            console.log(`row = ${row}, col = ${col}, Dut Number = ${col}`);
//                            console.log(`x = ${x}, y = ${y}, Dut Number = ${col}`);

                            $(document.createElementNS(xmlns, 'text')).attr({
                                x:x+(w/2), y:y+(h/2), class:'centerAlign', 'font-size':6
                            }).text(`${NumberToIndicater(col)}`).appendTo(svg);
//                            }).text(`${col}`).appendTo(svg);
                            $(document.createElementNS(xmlns, 'rect')).attr({
                                id:`DutID${col}`, value:col, class:`dut dut${col}`,
                                x:x, y:y, width:w, height:h, fill:'transparent', stroke:'black', 'stroke-width':'1', 'fill-opacity':0.5,
                                onmouseover:'showTooltip(event)', onmouseout:'hideTooltip(event)', onclick:'dutClick($(this).attr("value"))'
                            }).appendTo(svg);
                        }
                    });
                    x = sx;
                    y = y + (h + dh);
                });

                var svgWidth = sx + ((w + dw) * maxCol);
                var svgHeight = sy + ((h + dh) * maxRow);
                $(svg).attr({
                    id:'ProbeCard', align:'center', width:'100%', height:'100%',
                    viewBox:`0 0 ${svgWidth+20} ${svgHeight+20}`
                });

                x = svgWidth + 5;
                y = svgHeight + 5;
                console.log(`x = ${x}, y = ${y}, max col = ${maxCol}, max row = ${maxRow}`);
                $(document.createElementNS(xmlns, 'ellipse')).attr({
                    cx:(x/2), cy:(y/2)+2, rx:x/2, ry:y/2, fill:'none', stroke:'red', 'stroke-width':1
                }).appendTo(svg);

                document.getElementById("svgContainer").appendChild(svg);

                maxGROUP = BankMap.maxGROUP;

                // class add in dut rect
                console.log('class register');
                var total = 0;
                var dutNumber = [];
                BankMap.Banks.forEach( function(Bank, BankIdx) {
//                    console.log(`${BankIdx}-Bank`, Bank);
                    Bank.Pages.forEach( function(Page, PageIdx) {
//                        console.log(`${PageIdx}-Page`, Page);
                        Page.Chips.forEach( function(Chip, ChipIdx) {
//                            console.log(`${ChipIdx}-Chip`, Chip);
                            Chip.Duts.forEach( function(Dut, DutIdx) {
                dutNumber.push(parseInt(Dut));
                console.log(`dut number = ${Dut}, ${DutIdx}`);
                                $(`.dut${Dut}`).addClass(`Bank${BankIdx} Page${PageIdx} Chip${Page.Chips[ChipIdx].number}`);
                                $(`.dut${Dut}`).addClass((DutIdx==0)?'eDUT':'oDUT');//.attr('fill', color_table[BankIdx%20]);
                            total++;

                            });
//                            $(`.dut${Dut}`).addClass(`Bank${BankIdx} Page${PageIdx} Chip${Page.Chips[DutIdx>>1]}`);
//                            if( DutIdx & 0x1 ) {           // odd Dut.(red)
//                                $(`.dut${Dut}`).addClass('oDUT');//.attr('fill', color_table[BankIdx%20]);
//                            } else {                    // even Dut.(blue)
//                                $(`.dut${Dut}`).addClass('eDUT');//.attr('fill', color_table[BankIdx%20]);
//                            }
                        });
                    });
                });
    dutNumber.sort(function(a, b){return b - a});
                console.log('total = ', total);
                console.log('dut number = ', dutNumber);

                // device(2), maxDUTs(2560), maxGROUP(10), ChipsPerBank(30), DutsPerChip(2).
//                console.log('-----------------------------------------');
//                console.log(`device = ${BankMap.device}`);
//                console.log(`maxDUTs = ${BankMap.maxDUTs}`);
//                console.log(`ChipsPerBank = ${BankMap.ChipsPerBank}`);
//                console.log(`DutsPerChip = ${BankMap.DutsPerChip}`);
//                console.log(`BankCnt = ${BankMap.BankCnt}`);
//                console.log(`maxGROUP = ${BankMap.maxGROUP}`);
//                console.log('-----------------------------------------');
                document.getElementById('selectDutNumber').style.display = 'block';
            }


        function toHexString(arr) {
            return arr.map(function(val) {
                return '0x' + val.toString(16).toUpperCase();
            }).join(' ');
        }

        function toHexByteString(bytes) {
            return bytes.map(function(byte) {
                return '0x' + ('0' + (byte & 0xFF).toString(16).toUpperCase()).slice(-2);
            }).join(' ')
        }




        var SinglePage = {};
        function ExecuteEmulator(bytes) {
            var end = bytes.length;
            var idx = 0;
            var cmd;// = bytes[idx++];

            console.log(`SP2003 Command(${bytes.length}) : ` + toHexByteString(bytes));
            do {
                cmd = bytes[idx++];
                if( cmd == 0 ) continue;
                console.log(`cmd = ${cmd}`);

                switch ( cmd ) {
                    case 0xA5: case 0xA6: case 0xA7: case 0xA8: case 0xAF:
                        $('.eDUT').attr('fill', 'transparent');
                        $('.oDUT').attr('fill', 'transparent');
                        break;
                    case 0xA0: case 0xA1: case 0xA2: case 0xA3: case 0xA4: case 0xA9:// case 0xAF:
                        $('.oDUT').attr('fill', 'red');
                        $('.eDUT').attr('fill', 'blue');
                        break;
                }

                if( cmd == 0xA0 ) {
                    BankMap.Banks.forEach( function(Bank, BankIdx) {
                        Bank.Pages.forEach( function(Page, PageIdx) {
                            Page.Chips.forEach( function(Chip, ChipIdx) {   // ChipIdx : 0 ~ 15
                                Chip.SP2003.OnOff = 0;
                                Chip.SP2003.Reject = 0;
                            });
                        });
                    });
                } else if( cmd == 0xA1 ) {
                    BankMap.Banks.forEach( function(Bank, BankIdx) {
                        Bank.Pages.forEach( function(Page, PageIdx) {
                            Page.Chips.forEach( function(Chip, ChipIdx) {   // ChipIdx : 0 ~ 15
                                Chip.SP2003.OnOff = (1<<5)|(1<<4)|(1<<2)|(1<<1);
                                Chip.SP2003.Reject = 0;
                            });
                        });
                    });
                } else if( cmd == 0xA2 ) {
                    BankMap.Banks.forEach( function(Bank, BankIdx) {
                        Bank.Pages.forEach( function(Page, PageIdx) {
                            Page.Chips.forEach( function(Chip, ChipIdx) {   // ChipIdx : 0 ~ 15
                                Chip.SP2003.COMMON |= (1<<5);
                            });
                        });
                    });
                } else if( cmd == 0xA3 ) {
                    BankMap.Banks.forEach( function(Bank, BankIdx) {
                        Bank.Pages.forEach( function(Page, PageIdx) {
                            Page.Chips.forEach( function(Chip, ChipIdx) {   // ChipIdx : 0 ~ 15
                                Chip.SP2003.COMMON &= ~(1<<5);
                            });
                        });
                    });
                } else if( cmd == 0xA4 ) {
                    var ctrl = bytes[idx++] >> 4;
                    var onoff = (ctrl << 3) | ctrl;
                    BankMap.Banks.forEach( function(Bank, BankIdx) {
                        Bank.Pages.forEach( function(Page, PageIdx) {
                            Page.Chips.forEach( function(Chip, ChipIdx) {   // ChipIdx : 0 ~ 15
                                // SW0(bit[5]), LDO0(bit[4]), LDO1(bit[3]), SW1(bit[2]), LDO2(bit[1]), LDO3(bit[0])
                                Chip.SP2003.OnOff = onoff & ~Chip.SP2003.Reject;
                            });
                        });
                    });
                } else if( cmd == 0xA5 ) {
                    var chip = bytes[idx] >> 4;
                    var ctrl = bytes[idx++] & 0xF;
//                    console.log(`0x${cmd.toString(16)} : chip = ${chip}, ctrl = 0x${ctrl.toString(16)}`);

                    BankMap.Banks.forEach( function(Bank, BankIdx) {
                        Bank.Pages.forEach( function(Page, PageIdx) {
                            Page.Chips.forEach( function(Chip, ChipIdx) {   // ChipIdx : 0 ~ 15
                                if( Chip.SP2003.Assign == 0 ) return;

                                if( chip == (Chip.SP2003.Assign - 1) ) {
                                    $(`#DutID${Chip.Duts[0]}`).attr('fill', 'blue');
                                    $(`#DutID${Chip.Duts[1]}`).attr('fill', 'red');

                                    // chip변수에 의해서 선택된 Chip을 보여주기 위해서 SelectedDut.nChip을 변경한다.
                                    if( (SelectedDut.iBank == BankIdx) && (SelectedDut.iPage == PageIdx) ) {
                                        SelectedDut.nChip = Chip.number;
                                        SelectedDut.nDut = Chip.number;
                                    }

                                    // SW0(bit[5]), LDO0(bit[4]), LDO1(bit[3]), SW1(bit[2]), LDO2(bit[1]), LDO3(bit[0])
                                    var onoff = (ctrl << 3) | ctrl;
                                    Chip.SP2003.OnOff = onoff & ~Chip.SP2003.Reject;
                                } else {
                                    Chip.SP2003.OnOff = 0;
                                }
                            });
                        });
                    });
                } else if( cmd == 0xA6 ) {
                    var chip = bytes[idx] >> 4;
                    var ctrl = ((bytes[idx++] & 0xF) << 3);
                    ctrl = ctrl | ((bytes[idx++] & 0xF0) >> 4);

                    BankMap.Banks.forEach( function(Bank, BankIdx) {
                        Bank.Pages.forEach( function(Page, PageIdx) {
                            Page.Chips.forEach( function(Chip, ChipIdx) {   // ChipIdx : 0 ~ 15
                                if( Chip.SP2003.Assign == 0 ) return;

                                if( chip == (Chip.SP2003.Assign - 1) ) {
                                    $(`#DutID${Chip.Duts[0]}`).attr('fill', 'blue');
                                    $(`#DutID${Chip.Duts[1]}`).attr('fill', 'red');

                                    // chip변수에 의해서 선택된 Chip을 보여주기 위해서 SelectedDut.nChip을 변경한다.
                                    if( (SelectedDut.iBank == BankIdx) && (SelectedDut.iPage == PageIdx) ) {
                                        SelectedDut.nChip = Chip.number;
                                        SelectedDut.nDut = Chip.number;
                                    }

                                    Chip.SP2003.OnOff = ctrl & ~Chip.SP2003.Reject;
                                } else {
                                    Chip.SP2003.OnOff = 0;
                                }
                            });
                        });
                    });
                } else if( cmd == 0xA7 ) {
                    var chip = bytes[idx] >> 4;
                    var ctrl = bytes[idx] & 0xF;

                    if( SinglePage.dut != 0 ) {            // single page에만 동작한다.
//                        console.log('SinglePage : ', SinglePage);
                        BankMap.Banks[SinglePage.bank].Pages[SinglePage.page].Chips.some(function(Chip, ChipIdx) {
                            if( chip == ChipIdx ) {
                                // chip변수에 의해서 선택된 Chip을 보여주기 위해서 SelectedDut.nChip을 변경한다.
                                SelectedDut.nChip = Chip.number;
                                SelectedDut.nDut = Chip.number;

                                // SW0(bit[5]), LDO0(bit[4]), LDO1(bit[3]), SW1(bit[2]), LDO2(bit[1]), LDO3(bit[0])
                                Chip.SP2003.Reject |= (ctrl & 0x8) ? (ctrl & 0x7) : ((ctrl & 0x7)<<3);
                                Chip.SP2003.OnOff &= ~Chip.SP2003.Reject;
                                return true;
                            }
                            return false;
                        });
                    } else {
                        BankMap.Banks.forEach( function(Bank, BankIdx) {
                            Bank.Pages.forEach( function(Page, PageIdx) {
                                Page.Chips.some( function(Chip, ChipIdx) {   // ChipIdx : 0 ~ 15
                                    if( chip == ChipIdx ) {
                                        // chip변수에 의해서 선택된 Chip을 보여주기 위해서 SelectedDut.nChip을 변경한다.
                                        SelectedDut.nChip = Chip.number;
                                        SelectedDut.nDut = Chip.number;

                                        // SW0(bit[5]), LDO0(bit[4]), LDO1(bit[3]), SW1(bit[2]), LDO2(bit[1]), LDO3(bit[0])
                                        Chip.SP2003.Reject |= (ctrl & 0x8) ? (ctrl & 0x7) : ((ctrl & 0x7)<<3);
                                        Chip.SP2003.OnOff &= ~Chip.SP2003.Reject;
                                        return true;
                                    }
                                    return false;
                                });
                            });
                        });
                    }

                    $(`#DutID${SinglePage.dut}`).attr('fill', 'gray');

                    // SelectedDut update.
                    SelectedDut.iBank = SinglePage.bank;
                    SelectedDut.iPage = SinglePage.page;
                    SelectedDut.nChip = SinglePage.chip + 1;
                    SelectedDut.nDut = SinglePage.dut;

                    SinglePage.dut = 0;    // khjung
                } else if( cmd == 0xA8 ) {          // 선택된 Chip의 PMIC를 동일하게 동작시키고, 다른 Chip은 All Off한다.
                    var select = (bytes[idx++] << 8);
                    select = select | bytes[idx++];
                    var ctrl = (bytes[idx++] >> 4) & 0x7;
//                    console.log(`0x${cmd.toString(16)} : select(0x${select.toString(16)}), ctrl(0x${ctrl.toString(16)})`);

                    BankMap.Banks.forEach( function(Bank, BankIdx) {
                        Bank.Pages.forEach( function(Page, PageIdx) {
                            Page.Chips.some( function(Chip, ChipIdx) {   // ChipIdx : 0 ~ 15
                                if( Chip.SP2003.Assign == 0 ) return;

                                if( select & (1<<(15-ChipIdx)) ) {
                                    $(`#DutID${Chip.Duts[0]}`).attr('fill', 'blue');
                                    $(`#DutID${Chip.Duts[1]}`).attr('fill', 'red');

                                    // chip변수에 의해서 선택된 Chip을 보여주기 위해서 SelectedDut.nChip을 변경한다.
                                    if( (SelectedDut.iBank == BankIdx) && (SelectedDut.iPage == PageIdx) ) {
                                        SelectedDut.nChip = Chip.number;
                                        SelectedDut.nDut = Chip.number;
                                    }

                                    // SW0(bit[5]), LDO0(bit[4]), LDO1(bit[3]), SW1(bit[2]), LDO2(bit[1]), LDO3(bit[0])
                                    var onoff = (ctrl << 3) | ctrl;
                                    Chip.SP2003.OnOff = onoff & ~Chip.SP2003.Reject;
                                } else {
                                    Chip.SP2003.OnOff = 0;
                                }
                            });
                        });
                    });
                } else if( cmd == 0xA9 ) {
                    var level = (bytes[idx++] << 4);
                    level = level | (bytes[idx++] >> 4);
                    BankMap.Banks.forEach( function(Bank, BankIdx) {
                        Bank.Pages.forEach( function(Page, PageIdx) {
                            Page.Chips.forEach( function(Chip, ChipIdx) {   // ChipIdx : 0 ~ 15
                                Chip.SP2003.LDO02Level = level;
                                Chip.SP2003.LDO13Level = level;
                            });
                        });
                    });
                } else if( cmd == 0xAD ) {
//                    console.log(`0xAD Command.`);
                } else if( cmd == 0xAE ) {
                    var ctrl = (bytes[idx++] >> 4) & 0xF;

                    SP2003List.forEach(function(chip, idx, arr) {
                        chip.ExpandCommand = ctrl;
                    });
                } else if( cmd == 0xAF ) {
                    var select = (bytes[idx++] << 8);
                    select = select | bytes[idx++];
//                    console.log(`select = 0x${select.toString(16)}`);
                    BankMap.Banks.forEach( function(Bank, BankIdx) {
                        Bank.Pages.forEach( function(Page, PageIdx) {
                            var mask = select;
                            Page.Chips.forEach( function(Chip, ChipIdx) {   // ChipIdx : 0 ~ 15
                                if( Chip.SP2003.Assign == 0 ) {
                                    for(var i=0; i<16; i++) {
                                        if( mask & (1<<(15-i)) ) {
                                            Chip.SP2003.Group = i;
                                            Chip.SP2003.Assign = (i+1);
                                            mask &= ~(1<<(15-i));
                                            break;
                                        }
                                    }
                                }
                            });
                        });
                    });
//                console.log('BankMap : ', BankMap);
                }
//                console.log(`idx = ${idx}`);
            } while( end != idx );

            BankMap.Banks.forEach( function(Bank, BankIdx) {
                Bank.Pages.forEach( function(Page, PageIdx) {
                    Page.Chips.forEach( function(Chip, ChipIdx) {   // ChipIdx : 0 ~ 15
                        if( Chip.SP2003.Reject & 0x38 ) {
                            $(`#DutID${Chip.Duts[0]}`).attr('fill', 'gray');
                        }
                        if( Chip.SP2003.Reject & 0x07 ) {
                            $(`#DutID${Chip.Duts[1]}`).attr('fill', 'gray');
                        }
                    });
                });
            });
        }


        // ATE Command to PS2003 bytes command.
        function ATECommandParser(ATE)
        {
            var cmd = ATE[0];
            var chip;
            var ctrl;
            var bytes = [];

//            console.log(`ATECommandParser() : ` + toHexString(ATE));//0x${cmd.toString(16)}`);
            if( cmd == 0x01 ) {             // Init(All On)
                CurrentLevel = DefaultLevel;
                bytes.push(0xA9);
                bytes.push(CurrentLevel >> 4);
                bytes.push((CurrentLevel << 4) & 0xF0);
                bytes.push(0x0);            // OP cycle.
                bytes.push(0x0);            // shift cycle.
                if( maxGROUP > 8 ) {
                    bytes.push(0x0);            // shift cycle.
                }
                bytes.push(0xA1);
            } else if( cmd == 0x02 ) {      // Init(All Off)
                CurrentLevel = DefaultLevel;
                bytes.push(0xA0);
                bytes.push(0x0);            // OP cycle.
                bytes.push(0x0);            // shift cycle.
                if( maxGROUP > 8 ) {
                    bytes.push(0x0);            // shift cycle.
                }
                bytes.push(0xA9);
                bytes.push(CurrentLevel >> 4);
                bytes.push((CurrentLevel << 4) & 0xF0);
            } else if( cmd == 0x03 ) {      // Clipping Disable
                bytes.push(0xA3);
            } else if( cmd == 0x04 ) {      // Clipping Enable
                bytes.push(0xA2);
            } else if( cmd == 0x11 ) {      // All CMD 1D Rjt
                SinglePage.dut = ATE[1];
                BankMap.Banks.some( function(Bank, BankIdx) {
                    return Bank.Pages.some( function(Page, PageIdx) {
                        return Page.Chips.some( function(Chip, ChipIdx) {
                            if( Chip.Duts.includes(SinglePage.dut) ) {
                                // idx = 0 이면, 1'st PMIC이고, idx = 1 이면 2'nd PMIC를 제어한다.
                                var idx = Chip.Duts.indexOf(SinglePage.dut);
//                                console.log(`idx = ${idx}`);
                                SinglePage.idx = idx;
                                SinglePage.bank = BankIdx;
                                SinglePage.page = PageIdx;
                                SinglePage.chip = ChipIdx;
//                                console.log(`SinglePage : `, SinglePage);
                                return true;
                            }
                            return false;
                        });
                    });
                });

                // Reject Dut가 포함된 Page에 대해서만 명령이 생성되어야 한다.
                bytes.push(0xA7);
                bytes.push((SinglePage.chip<<4) | (SinglePage.idx << 3) | 0x7);
//                console.log(`dut = ${SinglePage.idx}, ${SinglePage.idx ^ 1}`);
            } else if( cmd == 0x99 ) {      // OPEN CMD
            } else if( cmd == 0xAA ) {      // CLOSE CMD
            } else if( cmd == 0xB1 ) {      // 1D Rjt(PWR1 On)
                SinglePage.dut = ATE[1];
//                SinglePage.cmd = 0xA7;
//                console.log(SinglePage);
//                console.log(`dut = ${dut}`);
                BankMap.Banks.some( function(Bank, BankIdx) {
                    return Bank.Pages.some( function(Page, PageIdx) {
                        return Page.Chips.some( function(Chip, ChipIdx) {
                            if( Chip.Duts.includes(SinglePage.dut) ) {
                                var idx = Chip.Duts.indexOf(SinglePage.dut);
//                            console.log(`idx = ${idx}`);
                                SinglePage.idx = idx;
                                SinglePage.bank = BankIdx;
                                SinglePage.page = PageIdx;
                                SinglePage.chip = ChipIdx;
//                            console.log('SinglePage : ', SinglePage);
                                return true;
                            }
                            return false;
                        });
                    });
                });

                bytes.push(0xA7);
                bytes.push((SinglePage.chip<<4) | (SinglePage.idx << 3) | 0x1);
                bytes.push(0x0);            // OP cycle.
                bytes.push(0x0);            // shift cycle.
                if( maxGROUP > 8 ) {
                    bytes.push(0x0);            // shift cycle.
                }
                bytes.push(0xA4);
                bytes.push(0x60);
            } else if( cmd == 0xB2 ) {      // new DC Grp
                if( maxGROUP < 10 ) return;
                var m = (maxGROUP + 2) + (maxGROUP >> 1);
                var newGroup = ATE[1] + 16;
                var select;

                bytes.push(0xA8);
                if( newGroup == maxGROUP ) {
                    select = 0xFF00;
                } else if( newGroup == (maxGROUP+1) ) {
                    select = 0x00FF;
                } else {
                    var shift = newGroup - (maxGROUP + 2);
                    select = 0xC000 >> (shift * 2);
                }
                bytes.push(select >> 8);
                bytes.push(select & 0xFF);
                bytes.push(0x60);
            } else if( cmd == 0xB4 ) {      // new ICC/ICCQ
                if( maxGROUP < 10 ) return;
                var newGroup = ATE[1] + 16;
                bytes.push(0xA6);
                if( (newGroup & 0x1) == 0 ) {
                    bytes.push((newGroup << 3) | 0x04);
                    bytes.push(0x10);
                } else {
                    bytes.push((newGroup << 3) | 0x01);
                    bytes.push(0x40);
                }
            } else if( cmd == 0xD2 ) {      // All Grp ON(LDO)
                // LDO의 출력은 Data In CMD로 입력된 전압 값으로 변경되고, SW0/SW1/LDO0/LDO2는 ON, LDO1/LDO3는 OFF된다.
                bytes.push(0xA9);
                bytes.push(CurrentLevel >> 4);
                bytes.push((CurrentLevel << 4) & 0xF0);
                bytes.push(0x0);            // OP cycle.
                bytes.push(0x0);            // shift cycle.
                if( maxGROUP > 8 ) {
                    bytes.push(0x0);            // shift cycle.
                }
                bytes.push(0xA4);
                bytes.push(0x60);
            } else if( cmd == 0xD4 ) {      // All Grp On(LDO)
                // LDO의 출력은 Default 설정 값으로 변경되고, SW0/SW1/LDO0/LDO2는 ON, LDO1/LDO3는 OFF된다.
                bytes.push(0xA9);
                bytes.push(DefaultLevel >> 4);
                bytes.push((DefaultLevel << 4) & 0xF0);
                bytes.push(0x0);            // OP cycle.
                bytes.push(0x0);            // shift cycle.
                if( maxGROUP > 8 ) {
                    bytes.push(0x0);            // shift cycle.
                }
                bytes.push(0xA4);
                bytes.push(0x60);
            } else if( cmd == 0xDC ) {      // All Grp Off(LDO)
                // LDO의 출력은 Data In CMD로 입력된 전압 값으로 변경되고, SW0/SW1/LDO0/LDO1/LDO2/LDO3는 OFF된다.
                bytes.push(0xA4);
                bytes.push(0x00);
                bytes.push(0x0);            // OP cycle.
                bytes.push(0x0);            // shift cycle.
                if( maxGROUP > 8 ) {
                    bytes.push(0x0);            // shift cycle.
                }
                bytes.push(0xA9);
                bytes.push(CurrentLevel >> 4);
                bytes.push((CurrentLevel << 4) & 0xF0);
            } else if( cmd == 0xE0 ) {      // PMIC Default Set
                DefaultLevel = ATE[1];
//                console.log(`DefaultLevel = ${DefaultLevel}`);
            } else if( cmd == 0xE1 ) {      // PMIC Data Set
                CurrentLevel = ATE[1];
//                console.log(`CurrentLevel = ${CurrentLevel}`);
            } else if( cmd == 0xE2 ) {      // PMIC Max Set
                MaxLevel = ATE[1];
//                console.log(`MaxLevel = ${MaxLevel}`);
            } else if( cmd == 0xAF ) {      // Chip Address Assignment.
                bytes.push(ATE[0]);
                bytes.push(ATE[1]>>8);
                bytes.push(ATE[1] & 0xFF);
            } else {
                var group = cmd & 0x0F;
                cmd = cmd & 0xF0;
//                console.log(`group = ${group}, maxGROUP = ${maxGROUP}`);
                if( cmd == 0x20 ) {         // DC Grp.
                    if( group < maxGROUP ) {
                        bytes.push(0xA5);
                        bytes.push((group<<4)|0x06);
                    } else {
                        var select = 0;
                        bytes.push(0xA8);
                        if( group == maxGROUP ) {
                            for(var i=0; i<(maxGROUP >> 1); i++) {
                                select |= (1<<(15-i));
                            }
                        } else if( group == (maxGROUP+1) ) {
                            for(var i=(maxGROUP>>1); i<maxGROUP; i++) {
                                select |= (1<<(15-i));
                            }
                        } else if( group < ((maxGROUP+2) + (maxGROUP >> 1)) ) {
                            var i = (group - (maxGROUP + 2)) << 1;
                            select = (0xC000 >> i);
                        }
                        bytes.push((select >> 8) & 0xFF);
                        bytes.push(select & 0xFF);
                        bytes.push(0x60);
                    }
                } else if( cmd == 0x30 ) {  // ICC/ICCQ
                    var chip = group >> 1;
                    bytes.push(0xA6);
                    if( (group & 0x1) == 0 ) {
                        bytes.push((chip << 4) | 0x04);
                        bytes.push(0x10);
                    } else {
                        bytes.push((chip << 4) | 0x01);
                        bytes.push(0x40);
                    }
                } else if( cmd == 0x40 ) {  // AC Grp(LDO).
                    bytes.push(0xA9);
                    bytes.push(CurrentLevel >> 4);
                    bytes.push((CurrentLevel << 4) & 0xF0);
                    bytes.push(0x0);            // OP cycle.
                    bytes.push(0x0);            // shift cycle.
                    if( maxGROUP > 8 ) {
                        bytes.push(0x0);            // shift cycle.
                    }
                    bytes.push(0xA4);
                    bytes.push(0x60);
                } else if( (cmd == 0x50) || (cmd == 0x60) || (cmd == 0x70) ) {  // Data In.
                } else if( cmd == 0x80 ) {  // Incoming Bypass Grp.
                    bytes.push(0xA5);
                    bytes.push((group << 4) | 0x4);
                } else if( cmd == 0xC0 ) {  // Incoming LDO Grp.
                    bytes.push(0xA5);
                    bytes.push((group << 4) | 0x2);
                }
            }

//            console.log(`Tx(${bytes.length}) : ` + toHexByteString(bytes));

            return bytes;
        }


            function OpenCommandList() {
//                console.log(`Screen : width = ${window.screen.width}, height = ${window.screen.height}`);
//                console.log(`Window position : (${window.screenX}, ${window.screenY}), width(${window.innerWidth}), height(${window.innerHeight})`);
                var url = 'CommandList.html';

                url += `?DefaultLevel=${DefaultLevel}`;
                url += `&CurrentLevel=${CurrentLevel}`;
                url += `&MaxLevel=${MaxLevel}`;

                var width = 800;
                var height = 450;

                var startX = 0;
                var startY = 0;
                if( window.screenX > window.screen.width ) startX = window.screen.width;
                if( window.screenY > window.screen.height ) startY = window.screen.height;

                // 화면 중앙에 CardMap.html 파일을 출력한다.
                var left = ((window.screen.width - width) / 2) + startX;
                var top = ((window.screen.height - height) / 2) + startY;

//                console.log(`top = ${top}, left = ${left}`);
                // 자식 창을 open한다.
                var opt = `toolbar=no, menubar=no, location=no, resizable=yes, status=no, target=_blank`;
                opt += `, width=${width}, height=${height}, top=${top}, left=${left}`;
                CmdListWindow = window.open(url, 'Command List Window', opt);
            }

//        var ATECmd;
            function RunCommand(ATECmd) {
//                console.log('Selected Dut : ', SelectedDut);
//                console.log(`RunCommand() : ATE Command(${ATECmd.length}) : ` + toHexString(ATECmd));
                var bytes = [];

//                if( (ATECmd[0] == 0xAD) || (ATECmd[0] == 0xAE) || (ATECmd[0] == 0xAF) ) {
//                } else {
                    bytes = ATECommandParser(ATECmd);
//                }
                if( bytes.length != 0 ) {
                    bytes.push(0x0);            // OP cycle.
                    bytes.push(0x0);            // shift cycle.
                    if( maxGROUP > 8 ) {
                        bytes.push(0x0);            // shift cycle.
                    }

                    // SelectedDut를 변경한다.
                    // ATE Command에 의해서 동작하는 Chip을 보여주기 위해서 변경한다.
                    // SelectedDut.nChip, SelectedDut.nDut만 수정한다.
                    ExecuteEmulator(bytes);

                    OpenCommandTime(bytes);

                    // Bank.html
                    if( SelectedDut.nDut == 0 ) {     // not selected.
                        SelectedDut.iBank = 0;
                        SelectedDut.iPage = 0;
                        SelectedDut.nChip = 1;
                        SelectedDut.nDut = 1;
                    }
//                    console.log('Selected Dut : ', SelectedDut);
                    OpenBankView();
                }

//                OpenRTLView(ATECmd, bytes);
            }

        var TimeWindow;
        function OpenCommandTime(bytes) {
            var url = `timing.html?Bytes=${bytes}`;
            var width = (bytes.length * 90) + 150;
            var height = 340;

            // BankMap화면의 우측 상단에 시작점을 맞추어서 'timing.html'을 출력한다.
            var left = window.screenX + window.innerWidth+2;
            var top = window.screenY;

//            console.log(`width = ${width}, height = ${height}, top = ${top}, left = ${left}`);

            var opt = `toolbar=no, menubar=no, location=no, status=no, target=_blank`;
            opt += `, width=${width}, height=${height}, top=${top}, left=${left}`;

            TimeWindow = window.open(url, 'SPI Timing', opt);
        }
        </script>
    </body>
</html>

